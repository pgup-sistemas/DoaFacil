{% extends "base.html" %}

{% block title %}Cadastrar Unidade - DoaFácil{% endblock %}

{% block extra_css %}
<style>
.form-section {
    border: 1px solid #e8e8e8;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: #fafafa;
}

.form-section h3 {
    color: #363636;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #3273dc;
}

.field-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.required-field::after {
    content: " *";
    color: #f14668;
}

.optional-field::after {
    content: " (opcional)";
    color: #7a7a7a;
    font-size: 0.9em;
}

.address-fields {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 15px;
}

.address-fields .field:first-child {
    grid-column: 1 / -1;
}

.address-fields .field:nth-child(2) {
    grid-column: 1 / 2;
}

.address-fields .field:nth-child(3) {
    grid-column: 2 / 3;
}

.address-fields .field:nth-child(4) {
    grid-column: 1 / -1;
}

.address-fields .field:nth-child(5) {
    grid-column: 1 / 2;
}

.address-fields .field:nth-child(6) {
    grid-column: 2 / 3;
}

.address-fields .field:nth-child(7) {
    grid-column: 3 / 4;
}

@media (max-width: 768px) {
    .field-group {
        grid-template-columns: 1fr;
    }
    
    .address-fields {
        grid-template-columns: 1fr;
    }
    
    .address-fields .field {
        grid-column: 1 / -1 !important;
    }
}
</style>
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div class="columns is-centered">
            <div class="column is-10">
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-title">
                            <h1 class="title is-3">
                                <i class="fas fa-building mr-2"></i>
                                Cadastrar Nova Unidade Organizadora
                            </h1>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="notification is-info is-light mb-4">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Informação:</strong> Preencha os dados da sua organização. Os campos marcados com * são obrigatórios.
                        </div>
                        
                        <form method="POST" id="unidade-form">
                            {{ form.hidden_tag() }}
                            
                            <!-- Seção 1: Informações Básicas -->
                            <div class="form-section">
                                <h3><i class="fas fa-info-circle mr-2"></i>Informações Básicas</h3>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label required-field">{{ form.nome.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.nome(class="input", placeholder="Ex: Igreja Nossa Senhora da Paz") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-building"></i>
                                            </span>
                                        </div>
                                        {% if form.nome.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.nome.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.nome_fantasia.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.nome_fantasia(class="input", placeholder="Nome comercial") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-tag"></i>
                                            </span>
                                        </div>
                                        {% if form.nome_fantasia.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.nome_fantasia.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label required-field">{{ form.responsavel.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.responsavel(class="input", placeholder="Nome do responsável") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-user"></i>
                                            </span>
                                        </div>
                                        {% if form.responsavel.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.responsavel.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.tipo_organizacao.label }}</label>
                                        <div class="control has-icons-left">
                                            <div class="select is-fullwidth">
                                                {{ form.tipo_organizacao() }}
                                            </div>
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-church"></i>
                                            </span>
                                        </div>
                                        {% if form.tipo_organizacao.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.tipo_organizacao.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.email.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.email(class="input", placeholder="email@exemplo.com") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-envelope"></i>
                                            </span>
                                        </div>
                                        {% if form.email.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.email.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.email_secundario.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.email_secundario(class="input", placeholder="email2@exemplo.com") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-envelope"></i>
                                            </span>
                                        </div>
                                        {% if form.email_secundario.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.email_secundario.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label class="label optional-field">{{ form.descricao.label }}</label>
                                    <div class="control">
                                        {{ form.descricao(class="textarea", placeholder="Descreva brevemente sua organização, missão, valores...") }}
                                    </div>
                                    {% if form.descricao.errors %}
                                        <p class="help is-danger">
                                            {% for error in form.descricao.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Seção 2: Dados Legais -->
                            <div class="form-section">
                                <h3><i class="fas fa-gavel mr-2"></i>Dados Legais/Institucionais</h3>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.cnpj.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.cnpj(class="input", placeholder="XX.XXX.XXX/XXXX-XX") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-id-card"></i>
                                            </span>
                                        </div>
                                        {% if form.cnpj.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.cnpj.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.razao_social.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.razao_social(class="input", placeholder="Nome legal da organização") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-file-contract"></i>
                                            </span>
                                        </div>
                                        {% if form.razao_social.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.razao_social.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.data_fundacao.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.data_fundacao(class="input", type="date") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-calendar"></i>
                                            </span>
                                        </div>
                                        {% if form.data_fundacao.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.data_fundacao.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.registro_inscricao.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.registro_inscricao(class="input", placeholder="Registro específico") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-stamp"></i>
                                            </span>
                                        </div>
                                        {% if form.registro_inscricao.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.registro_inscricao.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Seção 3: Endereço -->
                            <div class="form-section">
                                <h3><i class="fas fa-map-marker-alt mr-2"></i>Endereço Completo</h3>
                                
                                <div class="field">
                                    <label class="label optional-field">{{ form.cep.label }}</label>
                                    <div class="control has-icons-left">
                                        {{ form.cep(class="input", placeholder="00000-000", id="cep-input") }}
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-search"></i>
                                        </span>
                                    </div>
                                    {% if form.cep.errors %}
                                        <p class="help is-danger">
                                            {% for error in form.cep.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </p>
                                    {% endif %}
                                    <p class="help">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Digite o CEP para preenchimento automático do endereço.
                                    </p>
                                </div>
                                
                                <div class="address-fields">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.logradouro.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.logradouro(class="input", placeholder="Rua, Avenida, etc.", id="logradouro-input", readonly=true) }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-road"></i>
                                            </span>
                                        </div>
                                        {% if form.logradouro.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.logradouro.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.numero.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.numero(class="input", placeholder="Nº", id="numero-input") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-home"></i>
                                            </span>
                                        </div>
                                        {% if form.numero.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.numero.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.complemento.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.complemento(class="input", placeholder="Apartamento, bloco, etc.", id="complemento-input") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-building"></i>
                                            </span>
                                        </div>
                                        {% if form.complemento.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.complemento.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.bairro.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.bairro(class="input", placeholder="Bairro", id="bairro-input", readonly=true) }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-map"></i>
                                            </span>
                                        </div>
                                        {% if form.bairro.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.bairro.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.cidade.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.cidade(class="input", placeholder="Cidade", id="cidade-input", readonly=true) }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-city"></i>
                                            </span>
                                        </div>
                                        {% if form.cidade.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.cidade.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.estado.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.estado(class="input", placeholder="UF", id="estado-input", readonly=true) }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-flag"></i>
                                            </span>
                                        </div>
                                        {% if form.estado.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.estado.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Seção 4: Contatos -->
                            <div class="form-section">
                                <h3><i class="fas fa-phone mr-2"></i>Contatos</h3>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.telefone_fixo.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.telefone_fixo(class="input", placeholder="(11) 9999-9999") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-phone"></i>
                                            </span>
                                        </div>
                                        {% if form.telefone_fixo.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.telefone_fixo.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.whatsapp_numero.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.whatsapp_numero(class="input", placeholder="11999999999") }}
                                            <span class="icon is-small is-left">
                                                <i class="fab fa-whatsapp"></i>
                                            </span>
                                        </div>
                                        {% if form.whatsapp_numero.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.whatsapp_numero.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.horario_funcionamento.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.horario_funcionamento(class="input", placeholder="Segunda a Sexta, 8h às 18h") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-clock"></i>
                                            </span>
                                        </div>
                                        {% if form.horario_funcionamento.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.horario_funcionamento.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.dias_funcionamento.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.dias_funcionamento(class="input", placeholder="Segunda a Sexta") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-calendar-day"></i>
                                            </span>
                                        </div>
                                        {% if form.dias_funcionamento.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.dias_funcionamento.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Seção 5: Presença Digital -->
                            <div class="form-section">
                                <h3><i class="fas fa-globe mr-2"></i>Presença Digital</h3>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.website_url.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.website_url(class="input", placeholder="https://seusite.com.br") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-globe"></i>
                                            </span>
                                        </div>
                                        {% if form.website_url.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.website_url.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.facebook_url.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.facebook_url(class="input", placeholder="https://facebook.com/sua-pagina") }}
                                            <span class="icon is-small is-left">
                                                <i class="fab fa-facebook"></i>
                                            </span>
                                        </div>
                                        {% if form.facebook_url.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.facebook_url.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.instagram_url.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.instagram_url(class="input", placeholder="https://instagram.com/seu-perfil") }}
                                            <span class="icon is-small is-left">
                                                <i class="fab fa-instagram"></i>
                                            </span>
                                        </div>
                                        {% if form.instagram_url.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.instagram_url.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.linkedin_url.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.linkedin_url(class="input", placeholder="https://linkedin.com/company/sua-empresa") }}
                                            <span class="icon is-small is-left">
                                                <i class="fab fa-linkedin"></i>
                                            </span>
                                        </div>
                                        {% if form.linkedin_url.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.linkedin_url.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label class="label optional-field">{{ form.youtube_url.label }}</label>
                                    <div class="control has-icons-left">
                                        {{ form.youtube_url(class="input", placeholder="https://youtube.com/@seu-canal") }}
                                        <span class="icon is-small is-left">
                                            <i class="fab fa-youtube"></i>
                                        </span>
                                    </div>
                                    {% if form.youtube_url.errors %}
                                        <p class="help is-danger">
                                            {% for error in form.youtube_url.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Seção 6: Dados para Relatórios -->
                            <div class="form-section">
                                <h3><i class="fas fa-chart-bar mr-2"></i>Dados para Relatórios</h3>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.categoria.label }}</label>
                                        <div class="control has-icons-left">
                                            <div class="select is-fullwidth">
                                                {{ form.categoria() }}
                                            </div>
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-tags"></i>
                                            </span>
                                        </div>
                                        {% if form.categoria.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.categoria.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.publico_alvo.label }}</label>
                                        <div class="control has-icons-left">
                                            {{ form.publico_alvo(class="input", placeholder="Crianças, Idosos, Famílias, etc.") }}
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-users"></i>
                                            </span>
                                        </div>
                                        {% if form.publico_alvo.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.publico_alvo.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label class="label optional-field">{{ form.area_atuacao.label }}</label>
                                        <div class="control has-icons-left">
                                            <div class="select is-fullwidth">
                                                {{ form.area_atuacao() }}
                                            </div>
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-map-marked-alt"></i>
                                            </span>
                                        </div>
                                        {% if form.area_atuacao.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.area_atuacao.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="field">
                                        <label class="label optional-field">{{ form.tamanho_organizacao.label }}</label>
                                        <div class="control has-icons-left">
                                            <div class="select is-fullwidth">
                                                {{ form.tamanho_organizacao() }}
                                            </div>
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-ruler-combined"></i>
                                            </span>
                                        </div>
                                        {% if form.tamanho_organizacao.errors %}
                                            <p class="help is-danger">
                                                {% for error in form.tamanho_organizacao.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="field is-grouped is-grouped-centered mt-5">
                                <div class="control">
                                    <button type="submit" class="button is-primary is-rounded is-medium">
                                        <i class="fas fa-save mr-2"></i>
                                        Cadastrar Unidade
                                    </button>
                                </div>
                                <div class="control">
                                    <a href="{{ url_for('main.admin_dashboard') }}" class="button is-light is-rounded is-medium">
                                        <i class="fas fa-arrow-left mr-2"></i>
                                        Voltar
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Info Box -->
                <div class="notification is-info is-light mt-4">
                    <div class="content">
                        <h4 class="title is-5">
                            <i class="fas fa-info-circle mr-2"></i>
                            Sobre as Unidades Organizadoras
                        </h4>
                        <p>
                            Uma <strong>Unidade Organizadora</strong> pode ser qualquer organização que precise arrecadar doações:
                        </p>
                        <ul>
                            <li><strong>Igrejas e templos religiosos</strong> - para campanhas de caridade</li>
                            <li><strong>ONGs</strong> - para projetos sociais</li>
                            <li><strong>Escolas</strong> - para eventos e melhorias</li>
                            <li><strong>Hospitais</strong> - para campanhas de saúde</li>
                            <li><strong>Associações</strong> - para atividades comunitárias</li>
                            <li><strong>Empresas</strong> - para ações de responsabilidade social</li>
                        </ul>
                        <p class="mt-3">
                            <strong>Dica:</strong> Quanto mais informações você fornecer, mais profissional será a apresentação da sua organização nas listas de doação.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== FUNÇÕES PARA CONSULTA DE CEP =====
    
    // Elementos do formulário de endereço
    const cepInput = document.getElementById('cep-input');
    const logradouroInput = document.getElementById('logradouro-input');
    const bairroInput = document.getElementById('bairro-input');
    const cidadeInput = document.getElementById('cidade-input');
    const estadoInput = document.getElementById('estado-input');
    
    // Variáveis para controle da consulta
    let consultaCepTimeout;
    let consultandoCep = false;
    
    // Função para consultar CEP
    async function consultarCep(cep) {
        if (!cep || cep.length < 8) {
            return null;
        }
        
        try {
            // Limpar CEP (remover caracteres especiais)
            const cepLimpo = cep.replace(/\D/g, '');
            
            if (cepLimpo.length !== 8) {
                return null;
            }
            
            // Mostrar loading
            mostrarLoadingCep();
            
            // Fazer requisição para nossa API
            const response = await fetch(`/api/consultar-cep/${cepLimpo}`);
            const data = await response.json();
            
            if (data.success) {
                return data.endereco;
            } else {
                throw new Error(data.error || 'CEP não encontrado');
            }
            
        } catch (error) {
            console.error('Erro ao consultar CEP:', error);
            throw error;
        } finally {
            // Remover loading
            removerLoadingCep();
        }
    }
    
    // Função para preencher campos de endereço
    function preencherEndereco(endereco) {
        if (!endereco) return;
        
        // Preencher campos
        if (logradouroInput) logradouroInput.value = endereco.logradouro || '';
        if (bairroInput) bairroInput.value = endereco.bairro || '';
        if (cidadeInput) cidadeInput.value = endereco.cidade || '';
        if (estadoInput) estadoInput.value = endereco.estado || '';
        
        // Formatar CEP
        if (cepInput && endereco.cep) {
            cepInput.value = endereco.cep;
        }
        
        // Mostrar notificação de sucesso
        mostrarNotificacao('Endereço preenchido automaticamente!', 'success');
        
        // Focar no campo número
        const numeroInput = document.getElementById('numero-input');
        if (numeroInput) {
            numeroInput.focus();
        }
    }
    
    // Função para limpar campos de endereço
    function limparEndereco() {
        if (logradouroInput) logradouroInput.value = '';
        if (bairroInput) bairroInput.value = '';
        if (cidadeInput) cidadeInput.value = '';
        if (estadoInput) estadoInput.value = '';
    }
    
    // Função para mostrar loading no campo CEP
    function mostrarLoadingCep() {
        if (!cepInput) return;
        
        consultandoCep = true;
        cepInput.classList.add('is-loading');
        
        // Adicionar ícone de loading
        const icon = cepInput.parentElement.querySelector('.icon');
        if (icon) {
            icon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
    }
    
    // Função para remover loading do campo CEP
    function removerLoadingCep() {
        if (!cepInput) return;
        
        consultandoCep = false;
        cepInput.classList.remove('is-loading');
        
        // Restaurar ícone original
        const icon = cepInput.parentElement.querySelector('.icon');
        if (icon) {
            icon.innerHTML = '<i class="fas fa-search"></i>';
        }
    }
    
    // Função para formatar CEP enquanto digita
    function formatarCepInput(cep) {
        const cepLimpo = cep.replace(/\D/g, '');
        
        if (cepLimpo.length <= 5) {
            return cepLimpo;
        } else {
            return cepLimpo.substring(0, 5) + '-' + cepLimpo.substring(5, 8);
        }
    }
    
    // Event listener para o campo CEP
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            const cep = e.target.value;
            
            // Formatar CEP enquanto digita
            const cepFormatado = formatarCepInput(cep);
            if (cepFormatado !== cep) {
                e.target.value = cepFormatado;
            }
            
            // Limpar timeout anterior
            if (consultaCepTimeout) {
                clearTimeout(consultaCepTimeout);
            }
            
            // Limpar endereço se CEP foi apagado
            if (cep.length < 8) {
                limparEndereco();
                return;
            }
            
            // Aguardar 1 segundo após parar de digitar para consultar
            consultaCepTimeout = setTimeout(async () => {
                if (consultandoCep) return;
                
                try {
                    const endereco = await consultarCep(cep);
                    if (endereco) {
                        preencherEndereco(endereco);
                    }
                } catch (error) {
                    // Não mostrar erro para CEPs inválidos, apenas log
                    console.log('CEP não encontrado ou inválido:', error.message);
                }
            }, 1000);
        });
        
        // Event listener para quando o campo perde o foco
        cepInput.addEventListener('blur', function(e) {
            const cep = e.target.value;
            
            // Se o CEP tem 8 dígitos e não foi consultado ainda, consultar
            if (cep.replace(/\D/g, '').length === 8 && !consultandoCep) {
                setTimeout(async () => {
                    try {
                        const endereco = await consultarCep(cep);
                        if (endereco) {
                            preencherEndereco(endereco);
                        }
                    } catch (error) {
                        console.log('CEP não encontrado:', error.message);
                    }
                }, 100);
            }
        });
    }
    
    // Função para mostrar notificação
    function mostrarNotificacao(mensagem, tipo) {
        // Criar notificação
        const notificacao = document.createElement('div');
        notificacao.className = `notification is-${tipo === 'success' ? 'success' : 'danger'} is-light`;
        notificacao.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        `;
        
        notificacao.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-2"></i>
            ${mensagem}
        `;
        
        document.body.appendChild(notificacao);
        
        // Remover automaticamente após 3 segundos (consistente com flash messages)
        setTimeout(() => {
            if (notificacao.parentElement) {
                notificacao.style.transition = 'opacity 0.3s ease-out';
                notificacao.style.opacity = '0';
                setTimeout(() => {
                    if (notificacao.parentElement) {
                        notificacao.remove();
                    }
                }, 300);
            }
        }, 3000);
    }
    
    // ===== FORMATAÇÃO DE CAMPOS =====
    
    // Formatar CNPJ
    const cnpjInput = document.querySelector('input[name="cnpj"]');
    if (cnpjInput) {
        cnpjInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
                e.target.value = value;
            }
        });
    }
    
    // Formatar telefone
    const telefoneInput = document.querySelector('input[name="telefone_fixo"]');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
                value = value.replace(/(\d)(\d{4})$/, '$1-$2');
                e.target.value = value;
            }
        });
    }
    
    // Formatar WhatsApp
    const whatsappInput = document.querySelector('input[name="whatsapp_numero"]');
    if (whatsappInput) {
        whatsappInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                e.target.value = value;
            }
        });
    }
});
</script>
{% endblock %} 