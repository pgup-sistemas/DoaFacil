{% extends "base.html" %}

{% block title %}{{ lista.nome }} - DoaFácil{% endblock %}

{% block extra_css %}
<style>
/* --- Controle de Visibilidade --- */
.desktop-view {
    display: block; /* Visível por padrão */
}
.mobile-view {
    display: none; /* Oculto por padrão */
}

/* Em telas de até 768px (mobile e tablets em modo retrato) */
@media screen and (max-width: 768px) {
    .desktop-view {
        display: none !important; /* Esconde a tabela do desktop */
    }
    .mobile-view {
        display: block !important; /* Mostra a lista do mobile */
    }
}

/* --- Layout Mobile --- */
.mobile-item-box .item-header {
    margin-bottom: 0.75rem;
}

.mobile-item-box .item-title {
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.25;
    margin-bottom: 0.25rem !important;
}

.mobile-item-box .item-description {
    word-wrap: break-word;
    overflow-wrap: break-word;
    font-size: 0.8rem;
    line-height: 1.4;
    min-height: 1.5rem; /* Garante espaço mesmo se vazio */
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero is-primary is-bold">
    <div class="hero-body">
        <div class="container">
            <div class="columns is-vcentered">
                <div class="column is-8">
                    <h1 class="title is-2 has-text-white">
                        <i class="fas fa-heart mr-3"></i>
                        {{ lista.nome }}
                    </h1>
                    <h2 class="subtitle is-4 has-text-white">
                        <i class="fas fa-building mr-2"></i>
                        {{ lista.unidade.nome }}
                    </h2>
                    {% if lista.descricao %}
                        <p class="has-text-white">{{ lista.descricao }}</p>
                    {% endif %}
                </div>
                <div class="column is-4 has-text-centered">
                    <div class="box has-background-white">
                        <h3 class="title is-4 has-text-primary">{{ "%.1f"|format(lista.percentual_conclusao) }}%</h3>
                        <p class="subtitle is-6">Concluído</p>
                        <progress class="progress is-primary" value="{{ lista.percentual_conclusao }}" max="100"></progress>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- PIX Section -->
{% if lista.aceita_pix and lista.chave_pix %}
<section class="section has-background-warning is-light">
    <div class="container">
        <div class="notification is-warning">
            <div class="media">
                <div class="media-left">
                    <span class="icon is-large">
                        <i class="fas fa-qrcode fa-2x"></i>
                    </span>
                </div>
                <div class="media-content">
                    <h4 class="title is-4">Doação via PIX</h4>
                    <p class="subtitle is-6">
                        <strong>Chave PIX:</strong> {{ lista.chave_pix }}
                    </p>
                    <p>
                        Você também pode fazer doações financeiras via PIX para ajudar na compra dos itens necessários.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Items List Section (Desktop View) -->
<section class="section desktop-view">
    <div class="container">
        <div class="has-text-centered mb-4">
            <h2 class="title is-3">Itens para Arrecadação</h2>
            <p class="subtitle is-6">Clique no item que você pode doar</p>
        </div>
        
        {% if lista.itens %}
            <div class="box">
                <div class="table-container">
                    <table class="table is-fullwidth is-striped is-hoverable">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Necessário</th>
                                <th>Arrecadado</th>
                                <th>Progresso</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in lista.itens %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ item.nome }}</strong>
                                        {% if item.descricao %}
                                            <br><small class="has-text-grey">{{ item.descricao }}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="has-text-weight-semibold">
                                        {{ item.quantidade_necessaria }} {{ item.unidade_medida }}
                                    </span>
                                </td>
                                <td>
                                    <span class="has-text-weight-semibold">
                                        {{ item.quantidade_arrecadada }} {{ item.unidade_medida }}
                                    </span>
                                </td>
                                <td>
                                    <div class="level is-mobile">
                                        <div class="level-left">
                                            <div class="level-item">
                                                <div>
                                                    <progress class="progress {{ 'is-success' if item.esta_completo else 'is-warning' if item.percentual_conclusao >= 75 else 'is-info' if item.percentual_conclusao >= 50 else 'is-danger' }}" 
                                                              value="{{ item.percentual_conclusao }}" max="100" style="width: 60px; height: 8px;">
                                                    </progress>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="level-right">
                                            <div class="level-item">
                                                <small class="has-text-grey">{{ "%.0f"|format(item.percentual_conclusao) }}%</small>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if not item.esta_completo %}
                                        <button class="button is-primary is-small is-rounded" 
                                                onclick="openDonateModal({{ item.id }}, '{{ item.nome }}', {{ item.quantidade_restante }}, '{{ item.unidade_medida }}')">
                                            <i class="fas fa-heart mr-1"></i>
                                            Doar
                                        </button>
                                    {% else %}
                                        <span class="tag is-success is-small">
                                            <i class="fas fa-check mr-1"></i>
                                            Completo
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="has-text-centered">
                <div class="notification is-info">
                    <i class="fas fa-info-circle mr-2"></i>
                    Nenhum item foi adicionado a esta lista ainda.
                </div>
            </div>
        {% endif %}
    </div>
</section>

<!-- Mobile Optimized List (Mobile View) -->
<section class="section mobile-view">
    <div class="container">
        <div class="has-text-centered mb-4">
            <h2 class="title is-4">Itens para Doação</h2>
        </div>
        
        {% if lista.itens %}
            {% for item in lista.itens %}
            <div class="box mb-3 mobile-item-box">
                <div class="columns is-mobile is-vcentered">
                    <div class="column is-8">
                        <div class="item-header">
                            <h4 class="title is-5 item-title">{{ item.nome }}</h4>
                            {% if item.descricao %}
                                <p class="subtitle is-7 has-text-grey item-description is-spaced">{{ item.descricao }}</p>
                            {% endif %}
                        </div>

                        <div class="item-body">
                            <div class="level is-mobile mb-2">
                                <div class="level-left">
                                    <div class="level-item">
                                        <div>
                                            <p class="heading is-7">Necessário</p>
                                            <p class="title is-6">{{ item.quantidade_necessaria }} {{ item.unidade_medida }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="level-right">
                                    <div class="level-item">
                                        <div>
                                            <p class="heading is-7">Arrecadado</p>
                                            <p class="title is-6">{{ item.quantidade_arrecadada }} {{ item.unidade_medida }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <progress class="progress {{ 'is-success' if item.esta_completo else 'is-warning' if item.percentual_conclusao >= 75 else 'is-info' if item.percentual_conclusao >= 50 else 'is-danger' }}" 
                                      value="{{ item.percentual_conclusao }}" max="100" style="height: 6px;">
                            </progress>
                            <small class="has-text-grey">{{ "%.0f"|format(item.percentual_conclusao) }}% concluído</small>
                        </div>
                    </div>
                    <div class="column is-4 has-text-centered">
                        {% if not item.esta_completo %}
                            <button class="button is-primary is-small is-rounded is-fullwidth" 
                                    onclick="openDonateModal({{ item.id }}, '{{ item.nome }}', {{ item.quantidade_restante }}, '{{ item.unidade_medida }}')">
                                <i class="fas fa-heart mr-1"></i>
                                Doar
                            </button>
                        {% else %}
                            <span class="tag is-success is-medium">
                                <i class="fas fa-check mr-1"></i>
                                Completo
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>
</section>

<!-- Donate Modal -->
<div id="donate-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">
                <i class="fas fa-hand-holding-heart mr-2"></i>
                Fazer Doação
            </p>
            <button class="delete" aria-label="close" onclick="closeDonateModal()"></button>
        </header>
        <form method="POST" action="{{ url_for('main.doar', slug=lista.slug) }}">
            {{ form.hidden_tag() }}
            <section class="modal-card-body">
                <div class="content">
                    <h4 id="modal-item-name" class="title is-4"></h4>
                    <p id="modal-item-info" class="subtitle is-6"></p>
                    
                    <div class="field">
                        <label class="label">{{ form.doador_nome.label }}</label>
                        <div class="control has-icons-left">
                            {{ form.doador_nome(class="input", placeholder="Seu nome") }}
                            <span class="icon is-small is-left">
                                <i class="fas fa-user"></i>
                            </span>
                        </div>
                        {% if form.doador_nome.errors %}
                            <p class="help is-danger">
                                {% for error in form.doador_nome.errors %}
                                    {{ error }}
                                {% endfor %}
                            </p>
                        {% endif %}
                    </div>
                    
                    <div class="field">
                        <label class="label">{{ form.quantidade.label }}</label>
                        <div class="control has-icons-left">
                            {{ form.quantidade(class="input", type="number", min="1", id="modal-quantidade") }}
                            <span class="icon is-small is-left">
                                <i class="fas fa-calculator"></i>
                            </span>
                        </div>
                        {% if form.quantidade.errors %}
                            <p class="help is-danger">
                                {% for error in form.quantidade.errors %}
                                    {{ error }}
                                {% endfor %}
                            </p>
                        {% endif %}
                        <p class="help">Máximo disponível: <span id="modal-max-quantidade"></span></p>
                    </div>
                    
                    <div class="field">
                        <label class="label">{{ form.observacao.label }}</label>
                        <div class="control">
                            {{ form.observacao(class="textarea", placeholder="Observação opcional...") }}
                        </div>
                        {% if form.observacao.errors %}
                            <p class="help is-danger">
                                {% for error in form.observacao.errors %}
                                    {{ error }}
                                {% endfor %}
                            </p>
                        {% endif %}
                    </div>
                    
                    <input type="hidden" name="item_id" id="modal-item-id">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button type="submit" class="button is-primary is-rounded">
                    <i class="fas fa-heart mr-2"></i>
                    Confirmar Doação
                </button>
                <button type="button" class="button is-light is-rounded" onclick="closeDonateModal()">
                    Cancelar
                </button>
            </footer>
        </form>
    </div>
</div>

<!-- Share Section -->
<section class="section has-background-light">
    <div class="container">
        <div class="has-text-centered">
            <h3 class="title is-3">Compartilhe esta Lista</h3>
            <p class="subtitle is-5">Ajude a divulgar esta arrecadação</p>
            
            <div class="buttons is-centered">
                <a href="https://wa.me/?text=Ajude%20nossa%20arrecadação!%20{{ lista.nome }}%20-%20{{ request.url }}" 
                   target="_blank" class="button is-success is-rounded">
                    <i class="fab fa-whatsapp mr-2"></i>
                    WhatsApp
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" 
                   target="_blank" class="button is-info is-rounded">
                    <i class="fab fa-facebook mr-2"></i>
                    Facebook
                </a>
                <button class="button is-dark is-rounded" onclick="copyLink()">
                    <i class="fas fa-link mr-2"></i>
                    Copiar Link
                </button>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function openDonateModal(itemId, itemName, maxQuantity, unit) {
    document.getElementById('modal-item-id').value = itemId;
    document.getElementById('modal-item-name').textContent = itemName;
    document.getElementById('modal-item-info').textContent = 'Máximo disponível: ' + maxQuantity + ' ' + unit;
    document.getElementById('modal-quantidade').max = maxQuantity;
    document.getElementById('modal-max-quantidade').textContent = maxQuantity + ' ' + unit;
    
    document.getElementById('donate-modal').classList.add('is-active');
}

function closeDonateModal() {
    document.getElementById('donate-modal').classList.remove('is-active');
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        // Show success message
        const notification = document.createElement('div');
        notification.className = 'notification is-success is-light';
        notification.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-check mr-2"></i>
            Link copiado para a área de transferência!
        `;
        
        document.querySelector('.container').insertBefore(notification, document.querySelector('.container').firstChild);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 3000);
    });
}

// Close modal when clicking on background
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('donate-modal');
    modal.querySelector('.modal-background').addEventListener('click', closeDonateModal);
});
</script>
{% endblock %} 